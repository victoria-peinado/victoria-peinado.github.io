import{f as T,h as y,q as G,w as D,i as Q,Q as K,n as j,X as M,o as A,p as N,v,Y as F,r as u,U as q,a as I,j as e,B as b,x as U,C as E,k as S,l as $,d as O,L as _,E as V,y as L}from"./index-Di-Zw_TF.js";import{u as z,a as W,T as X}from"./Timer-byDiG925.js";import{C as Y}from"./ConfirmModal-BQmpQ8Rz.js";import{I as P}from"./Input-BKMhVuRP.js";async function H(s,a,r,o){try{const t=T(y,`gameSessions/${s}/answers`),i=G(t,D("questionIndex","==",a)),l=await Q(i),n=r.toMillis?r.toMillis():r,m=n+o*1e3;console.log(`Question started at: ${n}, cutoff at: ${m}`);const c=[];if(l.forEach(x=>{const p=x.data(),g=p.submittedAt?.toMillis()||0;p.correct&&g<=m?c.push({playerId:p.playerId,submittedAt:g}):p.correct&&g>m&&console.log(`Player ${p.playerId} answered too late (${g-m}ms over)`)}),console.log(`Found ${c.length} valid correct answers for question ${a}`),c.length===0)return 0;const f=c.map(x=>x.submittedAt),k=Math.min(...f),d=Math.max(...f),h=d-k||1,w=K(y);return c.forEach(x=>{const p=(d-x.submittedAt)/h,g=Math.round(p*40),C=100+g,B=x.submittedAt-n;console.log(`Player ${x.playerId}: ${C} points (base: 100, speed bonus: ${g})`);const R=j(y,`gameSessions/${s}/players/${x.playerId}`);w.update(R,{score:M(C),questionsCorrect:M(1),totalAnswerTimeMs:M(B)})}),await w.commit(),console.log(`Successfully updated scores for ${c.length} players`),c.length}catch(t){throw console.error("Error calculating scores:",t),t}}const J=async(s,a,r,o)=>{if(!s)throw new Error("No game ID provided.");try{const t=j(y,"gameSessions",s);let i=a;(r==="waiting"||r==="answerrevealed"||r==="leaderboard")&&(i=r==="waiting"?0:a+1);const l=o?.[i]?.duration||30,n={state:"questionactive",questionStartTime:v(),questionDuration:l,updatedAt:v()};return i!==a&&(n.currentQuestionIndex=i),await N(t,n),console.log(`Question ${i} shown with ${l}s timer`),i}catch(t){throw console.error("Error showing question:",t),new Error("Failed to show question.")}},Z=async(s,a)=>{if(!s)throw new Error("No game ID provided.");try{const r=j(y,"gameSessions",s),o=await A(r);if(!o.exists())throw new Error("Game session not found");const t=o.data(),i=await H(s,a,t.questionStartTime,t.questionDuration||30);return await N(r,{state:"answerrevealed",updatedAt:v()}),console.log(`Revealed answer, scored ${i} players`),i}catch(r){throw console.error("Error revealing answer:",r),new Error("Error revealing answer.")}},ee=async s=>{if(!s)throw new Error("No game ID provided.");try{const a=j(y,"gameSessions",s);await N(a,{state:"leaderboard",updatedAt:v()}),console.log("Leaderboard shown")}catch(a){throw console.error("Error showing leaderboard:",a),new Error("Error showing leaderboard.")}},se=async s=>{if(!s)throw new Error("No game ID provided.");try{const a=j(y,"gameSessions",s),r=await A(a);if(!r.exists())throw new Error("Game session not found");const t=r.data().gameName||"Trivia Game";console.log("Ending game, starting profile stat update..."),await F(s,t),console.log("Profile stat update complete."),await N(a,{state:"finished",updatedAt:v()}),console.log("Game ended successfully")}catch(a){throw console.error("Error ending game:",a),new Error("Failed to end game.")}};function ae(s,a,r){const[o,t]=u.useState(!1),[i,l]=u.useState(!1),n=u.useCallback((d,h)=>{h==="error"?q.error(d):h==="info"?q(d):q.success(d)},[]);u.useEffect(()=>{s?.state==="questionactive"&&l(!1)},[s?.currentQuestionIndex,s?.state]);const m=u.useCallback(async()=>{if(!(i||o)){l(!0),t(!0),n("Time's up! Calculating scores...","info");try{const d=await Z(s.id,s.currentQuestionIndex);n(`Scores calculated! ${d} players scored.`,"success")}catch(d){n(d.message,"error")}finally{t(!1)}}},[i,o,s,n]),c=u.useCallback(async()=>{t(!0),n("Showing question...","info",2e3);try{await J(s.id,s.currentQuestionIndex,s.state,r),n("Question is now live!","success",2e3)}catch(d){n(d.message,"error",2e3)}finally{t(!1)}},[s,r,n]),f=u.useCallback(async()=>{t(!0),n("Showing leaderboard...","info",2e3);try{await ee(s.id),n("Leaderboard is now visible!","success",2e3)}catch(d){n(d.message,"error",2e3)}finally{t(!1)}},[s,n]),k=u.useCallback(async()=>{if(confirm("Are you sure you want to end the game?")){t(!0),n("Ending game...","info");try{await se(s.id),n("Game ended!","success")}catch(d){n(d.message,"error")}finally{t(!1)}}},[s,n]);return{isBusy:o,handleMessage:n,handleTimerExpire:m,handleShowQuestion:c,handleShowLeaderboard:f,handleEndGame:k}}const re=async(s,a)=>{if(!s||!a)throw new Error("Game ID and message are required.");try{const r=j(y,"gameSessions",s);await N(r,{broadcastMessage:{message:a,sentAt:v()}}),console.log(`Broadcast message sent to game ${s}`)}catch(r){throw console.error("Error sending broadcast message:",r),new Error("Failed to send broadcast message.")}};function te({gameId:s,handleMessage:a}){const[r,o]=u.useState(""),[t,i]=u.useState(!1);return{broadcastInput:r,setBroadcastInput:o,isSending:t,handleSendBroadcast:async n=>{if(n.preventDefault(),!!r.trim()){i(!0);try{await re(s,r.trim()),a("Broadcast sent to all players!","success"),o("")}catch(m){a(m.message,"error")}finally{i(!1)}}}}}function ne(s){const[a,r]=u.useState(!1),t=`${window.location.origin}/#/join/${s}`;return{copied:a,shareUrl:t,handleCopyLink:()=>{navigator.clipboard.writeText(t).then(()=>{r(!0),setTimeout(()=>r(!1),2e3)}).catch(l=>{console.error("Failed to copy: ",l)})}}}function oe(s,a,r){const o=ae(s,a,r),t=te({gameId:a,handleMessage:o.handleMessage}),i=ne(s?.gamePin);return{...o,...t,...i}}function ie({onShowQuestion:s,onShowLeaderboard:a,onEndGame:r,gameSession:o,isBusy:t}){const{playSound:i,setMusic:l}=I(),n=o?.state,m=()=>{i("question_reveal"),l("music_question.mp3"),s()},c=()=>{l("music_lobby.mp3"),a()};return e.jsxs("div",{className:"space-y-3",children:[e.jsx(b,{onClick:m,disabled:t||n==="finished"||n==="questionactive",variant:"primary",className:"w-full py-3",children:n==="waiting"?"Start Game":"Next Question"}),e.jsx(b,{onClick:c,disabled:t||n!=="answerrevealed"&&n!=="leaderboard",variant:"secondary",className:"w-full py-3",children:"Show Leaderboard"}),e.jsx(b,{onClick:r,disabled:t||n==="finished",variant:"danger",className:"w-full py-3",children:"End Game"}),n==="questionactive"&&e.jsx("div",{className:"mt-4 p-4 bg-primary-dark rounded-lg border border-primary",children:e.jsx("p",{className:"text-primary-light font-semibold text-center",children:"Timer is running..."})}),n==="finished"&&e.jsx("div",{className:"mt-4 p-4 bg-neutral-800 rounded-lg border border-primary-light",children:e.jsx("p",{className:"text-primary-light font-semibold text-center",children:"Game has ended!"})})]})}function le({gameSession:s,loading:a}){const r=`/#/stream/${s?.id}`,o=i=>({waiting:{text:"Waiting",color:"text-neutral-400"},question:{text:"Question",color:"text-primary-light"},questionactive:{text:"Active",color:"text-primary-light"},answerrevealed:{text:"Answer Revealed",color:"text-secondary"},leaderboard:{text:"Leaderboard",color:"text-primary"},finished:{text:"Finished",color:"text-neutral-400"}})[i]||{text:i,color:"text-neutral-300"};if(a)return e.jsx("p",{className:"text-neutral-400",children:"Loading status..."});if(!s)return e.jsx("p",{className:"text-neutral-400",children:"No active game"});const t=o(s.state);return e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center justify-between p-3 bg-neutral-800 rounded-lg border border-neutral-700",children:[e.jsx("span",{className:"text-neutral-300 text-sm",children:"Game State:"}),e.jsx("span",{className:`font-bold uppercase text-sm ${t.color}`,children:t.text})]}),e.jsxs("div",{className:"flex items-center justify-between p-3 bg-neutral-800 rounded-lg border border-neutral-700",children:[e.jsx("span",{className:"text-neutral-300 text-sm",children:"Current Question:"}),e.jsxs("span",{className:"font-bold text-primary-light",children:["#",s.currentQuestionIndex+1]})]}),e.jsxs("div",{className:"p-3 bg-neutral-800 rounded-lg border border-primary-dark",children:[e.jsx("p",{className:"text-neutral-300 text-sm mb-2",children:"Stream View:"}),e.jsx("a",{href:r,target:"_blank",rel:"noopener noreferrer",className:"text-primary-light hover:text-primary font-semibold text-sm underline",children:"Open Stream Link →"})]})]})}const ce=async(s,a)=>{if(!s||!a)throw new Error("Game ID and Player ID are required.");try{const r=j(y,`gameSessions/${s}/players/${a}`);await N(r,{isKicked:!0}),console.log(`Player ${a} flagged as kicked from game ${s}`)}catch(r){throw console.error("Error kicking player:",r),new Error("Failed to kick player.")}},de=async(s,a,r)=>{if(!s||!a||!r)throw new Error("Game ID, Player ID, and message are required.");try{const o=j(y,`gameSessions/${s}/players/${a}`);await N(o,{directMessage:{message:r,sentAt:v()}}),console.log(`Direct message sent to player ${a}`)}catch(o){throw console.error("Error sending direct message:",o),new Error("Failed to send direct message.")}};function me(s){const[a,r]=u.useState([]),[o,t]=u.useState(!0),[i,l]=u.useState(!1),[n,m]=u.useState(null);u.useEffect(()=>{if(!s){t(!1);return}const h=T(y,`gameSessions/${s}/players`),w=G(h,D("hasExited","==",!1),D("isKicked","==",!1)),x=U(w,p=>{const g=p.docs.map(C=>({id:C.id,...C.data()}));r(g),t(!1)},p=>{console.error("Error fetching live players:",p),t(!1)});return()=>x()},[s]);const c=h=>{m(h),l(!0)},f=()=>{l(!1),m(null)};return{players:a,loading:o,isModalOpen:i,playerToKick:n,handleKickClick:c,handleCloseModal:f,handleConfirmKick:async()=>{if(n)try{await ce(s,n.id)}catch(h){console.error("Error kicking player:",h)}finally{f()}},handleMessageClick:async h=>{const w=window.prompt(`Send a direct message to ${h.nickname}:`);if(w&&w.trim())try{await de(s,h.id,w.trim()),alert("Message sent!")}catch(x){console.error("Error sending direct message:",x),alert("Failed to send message.")}}}}const ue=({player:s,onMessageClick:a,onKickClick:r})=>e.jsxs("div",{className:"flex items-center justify-between p-3 bg-neutral-800 rounded-lg hover:bg-neutral-700 transition border border-neutral-700",children:[e.jsxs("div",{className:"flex items-center gap-3 flex-1 min-w-0",children:[e.jsx("div",{className:"w-2 h-2 bg-primary-light rounded-full flex-shrink-0"}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("p",{className:"font-semibold text-neutral-100 truncate",children:s.nickname}),e.jsxs("p",{className:"text-xs text-neutral-400 font-mono",children:[s.score||0," pts"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-shrink-0",children:[e.jsx(b,{onClick:()=>a(s),variant:"secondary",className:"py-1 px-3 text-xs",children:"Message"}),e.jsx(b,{onClick:()=>r(s),variant:"danger",className:"py-1 px-3 text-xs",children:"Kick"})]})]}),he=u.memo(ue),xe=()=>e.jsxs("div",{className:"flex items-center justify-between p-4 h-20 bg-neutral-800 rounded-lg animate-pulse",children:[e.jsxs("div",{className:"flex flex-col space-y-2",children:[e.jsx("div",{className:"h-4 w-32 bg-neutral-700 rounded"}),e.jsx("div",{className:"h-3 w-24 bg-neutral-700 rounded"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx("div",{className:"h-8 w-16 bg-neutral-700 rounded"}),e.jsx("div",{className:"h-8 w-16 bg-neutral-700 rounded"})]})]});function pe({gameId:s}){const{players:a,loading:r,isModalOpen:o,playerToKick:t,handleKickClick:i,handleCloseModal:l,handleConfirmKick:n,handleMessageClick:m}=me(s);return r?e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:[...Array(5)].map((c,f)=>e.jsx(xe,{},f))}):e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-neutral-400 mb-4",children:[a.length," ",a.length===1?"player":"players"," online"]}),a.length===0?e.jsx("p",{className:"text-neutral-400 text-center py-8",children:"No players have joined yet."}):e.jsx("div",{className:"space-y-2 max-h-96 overflow-y-auto",children:a.map(c=>e.jsx(he,{player:c,onMessageClick:m,onKickClick:i},c.id))})]}),e.jsx(Y,{isOpen:o,onClose:l,onConfirm:n,title:"Kick Player?",message:`Are you sure you want to kick ${t?.nickname}? They will be removed from the game.`,confirmText:"Kick",confirmVariant:"danger"})]})}function fe({gamePin:s,copied:a,shareUrl:r,handleCopyLink:o}){return e.jsx(E,{children:e.jsxs(S,{className:"p-6",children:[e.jsxs($,{className:"mb-4",children:["Share Game (PIN: ",s,")"]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx(P,{type:"text",value:r,readOnly:!0,className:"flex-grow"}),e.jsx(b,{onClick:o,variant:a?"primary":"secondary",className:"sm:w-auto whitespace-nowrap",children:a?"✓ Copied!":"Copy Link"})]})]})})}function ge({broadcastInput:s,setBroadcastInput:a,isSending:r,handleSendBroadcast:o}){return e.jsx(E,{children:e.jsxs(S,{className:"p-6",children:[e.jsx($,{className:"mb-4",children:"Send Broadcast"}),e.jsxs("form",{onSubmit:o,className:"flex flex-col sm:flex-row gap-2",children:[e.jsx(P,{type:"text",value:s,onChange:t=>a(t.target.value),placeholder:"Type your message here...",disabled:r,className:"flex-grow"}),e.jsx(b,{type:"submit",variant:"primary",disabled:r||!s.trim(),className:"sm:w-auto whitespace-nowrap",children:r?"Sending...":"Send"})]})]})})}function ve(){const{gameId:s}=O(),{gameSession:a,loading:r,error:o}=z(s),{questions:t,loading:i}=W(a?.questionBankId),{isBusy:l,handleTimerExpire:n,handleShowQuestion:m,handleShowLeaderboard:c,handleEndGame:f,broadcastInput:k,setBroadcastInput:d,isSending:h,handleSendBroadcast:w,copied:x,shareUrl:p,handleCopyLink:g}=oe(a,s,t);return r||i?e.jsx(_,{}):o?e.jsx(V,{message:o}):a?e.jsxs("div",{children:[e.jsxs("div",{className:"mb-6 flex justify-between items-center",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-4xl font-display font-bold",children:a.gameName||"Untitled Game"}),e.jsxs("p",{className:"text-neutral-300 mt-2",children:["Game PIN:"," ",e.jsx("span",{className:"text-primary-light font-semibold",children:a.gamePin})]})]}),e.jsx(L,{to:"/admin",children:e.jsx(b,{variant:"secondary",children:"← Back to Dashboard"})})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"lg:col-span-2 space-y-6",children:[e.jsx(E,{children:e.jsxs(S,{className:"p-6",children:[e.jsx($,{className:"mb-4",children:"Game Controls"}),e.jsx(ie,{gameSession:a,questions:t,isBusy:l,onShowQuestion:m,onShowLeaderboard:c,onEndGame:f})]})}),e.jsx(E,{children:e.jsxs(S,{className:"p-6",children:[e.jsx($,{className:"mb-4",children:"Current Status"}),e.jsx(le,{gameSession:a}),a.state==="questionactive"&&a.questionDuration&&a.questionStartTime&&e.jsx("div",{className:"mt-4",children:e.jsx(X,{startTime:a.questionStartTime,duration:a.questionDuration,onExpire:n},a.currentQuestionIndex)})]})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsx(fe,{gamePin:a.gamePin,copied:x,shareUrl:p,handleCopyLink:g}),e.jsx(ge,{broadcastInput:k,setBroadcastInput:d,isSending:h,handleSendBroadcast:w})]})]}),e.jsx("div",{className:"lg:col-span-1",children:e.jsx(E,{className:"sticky top-6",children:e.jsxs(S,{className:"p-6",children:[e.jsx($,{className:"mb-4",children:"Live Players"}),e.jsx(pe,{gameId:s})]})})})]})]}):e.jsxs("div",{className:"text-center py-12",children:[e.jsx("h1",{className:"text-2xl font-bold text-secondary mb-4",children:"Game Not Found"}),e.jsx("p",{className:"text-neutral-300 mb-6",children:"Could not load game session."}),e.jsx(L,{to:"/admin",children:e.jsx(b,{variant:"secondary",children:"← Back to Dashboard"})})]})}export{ve as default};
